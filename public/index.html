<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard v2.4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1a1a2e; }
    ::-webkit-scrollbar-thumb { background: #4a4a6a; border-radius: 3px; }
    
    .badge { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; }
    .badge-bull { background: rgba(34,197,94,0.2); color: #22c55e; }
    .badge-bear { background: rgba(239,68,68,0.2); color: #ef4444; }
    .badge-neutral { background: rgba(156,163,175,0.2); color: #9ca3af; }
    .badge-caution { background: rgba(251,191,36,0.2); color: #fbbf24; }
    
    .tf-cell { 
      width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
      font-size: 8px; font-weight: 600; border-radius: 2px;
    }
    .tf-bull { background: rgba(34,197,94,0.4); color: #22c55e; }
    .tf-bear { background: rgba(239,68,68,0.4); color: #ef4444; }
    .tf-none { background: rgba(75,85,99,0.3); color: #6b7280; }
    
    .alert-item { transition: all 0.2s; }
    .alert-item:hover { background: rgba(255,255,255,0.05); }
    .alert-high { border-left: 3px solid #ef4444; }
    .alert-normal { border-left: 3px solid #3b82f6; }
    
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
    .pulse { animation: pulse 2s infinite; }
    
    .table-row:hover { background: rgba(255,255,255,0.03); }
    .custom-check { accent-color: #3b82f6; }
    select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
    
    .sort-indicator { font-size: 10px; color: #60a5fa; }
    .sort-indicator::after { content: ''; }
    .sort-indicator.asc::after { content: ' ‚ñ≤'; }
    .sort-indicator.desc::after { content: ' ‚ñº'; }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-4 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold text-blue-400">üìä Trading Dashboard</h1>
        <div class="flex items-center gap-2 text-sm text-gray-400">
          <span class="w-2 h-2 rounded-full bg-green-500 pulse"></span>
          <span id="symbolCount">0</span> symbols
        </div>
        <!-- Section Filter -->
        <div class="flex items-center gap-1 ml-4">
          <button onclick="setSection('all')" id="sectionAll" class="section-btn px-3 py-1 text-sm rounded bg-blue-600 text-white">All</button>
          <button onclick="setSection('crypto')" id="sectionCrypto" class="section-btn px-3 py-1 text-sm rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Crypto</button>
          <button onclick="setSection('stocks')" id="sectionStocks" class="section-btn px-3 py-1 text-sm rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Stocks</button>
          <button onclick="setSection('forex')" id="sectionForex" class="section-btn px-3 py-1 text-sm rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Forex</button>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <!-- Auto Refresh Controls -->
        <div class="flex items-center gap-2 bg-gray-700 rounded px-3 py-1.5">
          <label class="flex items-center gap-2 text-sm cursor-pointer">
            <input type="checkbox" id="autoRefreshToggle" class="custom-check" onchange="toggleAutoRefresh()" checked>
            <span>Auto Refresh</span>
          </label>
          <select id="refreshInterval" onchange="updateRefreshInterval()" class="bg-gray-600 border border-gray-500 rounded px-2 py-0.5 text-sm appearance-none pr-7">
            <option value="0">Off</option>
            <option value="15">15s</option>
            <option value="30">30s</option>
            <option value="60" selected>1m</option>
            <option value="120">2m</option>
            <option value="300">5m</option>
          </select>
        </div>
        <button onclick="openAlertSettings()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm">‚öôÔ∏è Alert Settings</button>
        <button onclick="refreshData()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-sm">üîÑ Refresh</button>
      </div>
    </div>
  </header>

  <div class="flex h-[calc(100vh-57px)]">
    
    <!-- Left Sidebar - Filters -->
    <aside class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col">
      <div class="p-3 border-b border-gray-700">
        <h2 class="font-semibold text-sm flex items-center gap-2">üîç Filters</h2>
      </div>
      <div class="flex-1 overflow-y-auto p-3 space-y-4">
        
        <!-- Quick Presets -->
        <div>
          <p class="text-xs text-gray-400 mb-2">Quick Presets</p>
          <div class="grid grid-cols-2 gap-2">
            <button onclick="applyPreset('long')" class="px-2 py-1.5 bg-green-600/20 border border-green-600/40 rounded text-green-400 text-xs hover:bg-green-600/30">üü¢ Long Setup</button>
            <button onclick="applyPreset('short')" class="px-2 py-1.5 bg-red-600/20 border border-red-600/40 rounded text-red-400 text-xs hover:bg-red-600/30">üî¥ Short Setup</button>
            <button onclick="applyPreset('confluence')" class="px-2 py-1.5 bg-blue-600/20 border border-blue-600/40 rounded text-blue-400 text-xs hover:bg-blue-600/30">‚≠ê High Confluence</button>
            <button onclick="clearFilters()" class="px-2 py-1.5 bg-gray-600/20 border border-gray-600/40 rounded text-gray-400 text-xs hover:bg-gray-600/30">‚úñ Clear</button>
          </div>
        </div>

        <!-- Zone Filters with TF Selection -->
        <div>
          <p class="text-xs text-gray-400 mb-2">Supply/Demand Zones</p>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="fDemand" class="custom-check">
              <span class="text-sm flex-1">In Demand</span>
              <select id="fDemandTF" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs appearance-none pr-6">
                <option value="1m">1m+</option>
                <option value="3m">3m+</option>
                <option value="5m">5m+</option>
                <option value="15m">15m+</option>
                <option value="30m">30m+</option>
                <option value="1h">1H+</option>
                <option value="4h" selected>4H+</option>
                <option value="12h">12H+</option>
                <option value="1d">1D+</option>
                <option value="1w">1W</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="fSupply" class="custom-check">
              <span class="text-sm flex-1">In Supply</span>
              <select id="fSupplyTF" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs appearance-none pr-6">
                <option value="1m">1m+</option>
                <option value="3m">3m+</option>
                <option value="5m">5m+</option>
                <option value="15m">15m+</option>
                <option value="30m">30m+</option>
                <option value="1h">1H+</option>
                <option value="4h" selected>4H+</option>
                <option value="12h">12H+</option>
                <option value="1d">1D+</option>
                <option value="1w">1W</option>
              </select>
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fDemandRej" class="custom-check"> Demand Rejection
            </label>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fSupplyRej" class="custom-check"> Supply Rejection
            </label>
          </div>
        </div>

        <!-- MSS/BOS Filters with TF Selection -->
        <div>
          <p class="text-xs text-gray-400 mb-2">MSS/BOS Trend</p>
          <div class="space-y-2">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fBullBias" class="custom-check"> Bullish Bias (Overall)
            </label>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fBearBias" class="custom-check"> Bearish Bias (Overall)
            </label>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="fBullTF" class="custom-check">
              <span class="text-sm flex-1">Bullish on</span>
              <select id="fBullTFSelect" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs appearance-none pr-6">
                <option value="1m">1m</option>
                <option value="3m">3m</option>
                <option value="5m">5m</option>
                <option value="15m">15m</option>
                <option value="30m">30m</option>
                <option value="1h">1H</option>
                <option value="4h">4H</option>
                <option value="12h" selected>12H</option>
                <option value="1d">1D</option>
                <option value="1w">1W</option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="fBearTF" class="custom-check">
              <span class="text-sm flex-1">Bearish on</span>
              <select id="fBearTFSelect" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs appearance-none pr-6">
                <option value="1m">1m</option>
                <option value="3m">3m</option>
                <option value="5m">5m</option>
                <option value="15m">15m</option>
                <option value="30m">30m</option>
                <option value="1h">1H</option>
                <option value="4h">4H</option>
                <option value="12h" selected>12H</option>
                <option value="1d">1D</option>
                <option value="1w">1W</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Momentum Filters with TF Selection -->
        <div>
          <p class="text-xs text-gray-400 mb-2">Momentum & Caution</p>
          <div class="space-y-2">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="fHasCaution" class="custom-check">
              <span class="text-sm flex-1">Has Caution</span>
              <select id="fCautionTF" class="bg-gray-700 border border-gray-600 rounded px-2 py-0.5 text-xs appearance-none pr-6">
                <option value="1m">1m-</option>
                <option value="3m">3m-</option>
                <option value="5m">5m-</option>
                <option value="15m">15m-</option>
                <option value="30m">30m-</option>
                <option value="1h">1H-</option>
                <option value="4h" selected>4H-</option>
                <option value="12h">12H-</option>
                <option value="1d">1D-</option>
                <option value="1w">1W-</option>
              </select>
            </div>
            <div class="flex items-center gap-2 mt-1">
              <span class="text-xs text-gray-400">Min Caution:</span>
              <input type="number" id="fMinCaution" min="0" max="10" value="0" class="w-14 px-2 py-0.5 bg-gray-700 border border-gray-600 rounded text-xs">
            </div>
          </div>
        </div>

        <!-- Multi-Algo Filters (Updated) -->
        <div>
          <p class="text-xs text-gray-400 mb-2">Multi-Algo Signals</p>
          <div class="space-y-1.5">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fOverbought" class="custom-check"> 15M + 1H Overbought
            </label>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" id="fOversold" class="custom-check"> 15M + 1H Oversold
            </label>
            <div class="border-t border-gray-700 my-2 pt-2">
              <p class="text-xs text-gray-500 mb-1.5">Algo 1</p>
              <div class="flex gap-4 ml-2">
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo1Buy" class="custom-check"> <span class="text-green-400">Buy</span>
                </label>
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo1Sell" class="custom-check"> <span class="text-red-400">Sell</span>
                </label>
              </div>
            </div>
            <div class="border-t border-gray-700 my-2 pt-2">
              <p class="text-xs text-gray-500 mb-1.5">Algo 2</p>
              <div class="flex gap-4 ml-2">
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo2Buy" class="custom-check"> <span class="text-green-400">Buy</span>
                </label>
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo2Sell" class="custom-check"> <span class="text-red-400">Sell</span>
                </label>
              </div>
            </div>
            <div class="border-t border-gray-700 my-2 pt-2">
              <p class="text-xs text-gray-500 mb-1.5">Algo 3</p>
              <div class="flex gap-4 ml-2">
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo3Buy" class="custom-check"> <span class="text-green-400">Buy</span>
                </label>
                <label class="flex items-center gap-1 text-sm cursor-pointer">
                  <input type="checkbox" id="fAlgo3Sell" class="custom-check"> <span class="text-red-400">Sell</span>
                </label>
              </div>
            </div>
          </div>
        </div>


      </div>
      <div class="p-3 border-t border-gray-700">
        <button onclick="applyFilters()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium">Apply Filters</button>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <!-- Tabs -->
      <div class="bg-gray-800 border-b border-gray-700 px-4 flex gap-1">
        <button onclick="switchTab('all')" id="tabAll" class="tab px-4 py-2.5 text-sm border-b-2 border-blue-500 text-blue-400">All Symbols</button>
        <button onclick="switchTab('longs')" id="tabLongs" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">üìà Longs</button>
        <button onclick="switchTab('shorts')" id="tabShorts" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">üìâ Shorts</button>
        <button onclick="switchTab('algo')" id="tabAlgo" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">ü§ñ Algo Signals</button>
        <button onclick="switchTab('obos')" id="tabObos" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">üî¥üü¢ OB/OS</button>
        <button onclick="switchTab('zones')" id="tabZones" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">üéØ Zone Rejections</button>
        <button onclick="switchTab('mssbos')" id="tabMssbos" class="tab px-4 py-2.5 text-sm border-b-2 border-transparent text-gray-400">üìä MSS/BOS</button>
      </div>
      
      <!-- MSS/BOS Criteria Panel -->
      <div id="mssbosCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-4 flex-wrap">
          <span class="text-sm font-medium text-cyan-400">üìä MSS/BOS Filter:</span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Primary TF:</span>
            <select id="mssbosTimeframe" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="1w">1W</option>
              <option value="1d">1D</option>
              <option value="12h">12H</option>
              <option value="4h" selected>4H</option>
              <option value="1h">1H</option>
              <option value="30m">30M</option>
              <option value="15m">15M</option>
              <option value="5m">5M</option>
              <option value="3m">3M</option>
              <option value="1m">1M</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Direction:</span>
            <select id="mssbosDirection" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="all">All</option>
              <option value="bull">Bullish Only</option>
              <option value="bear">Bearish Only</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Sort:</span>
            <select id="mssbosSort" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="bullish">Most Bullish First</option>
              <option value="bearish">Most Bearish First</option>
              <option value="symbol">Symbol A-Z</option>
            </select>
          </div>
          <div class="text-xs text-gray-500 ml-4">Click column headers to filter by that timeframe</div>
        </div>
      </div>
      
      <!-- Algo Signals Sub-Tabs Panel -->
      <div id="algoCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-4">
          <span class="text-sm font-medium text-purple-400">ü§ñ Algo Filter:</span>
          <div class="flex gap-1">
            <button onclick="setAlgoFilter('all')" id="algoFilterAll" class="algo-sub-tab px-3 py-1.5 text-xs rounded bg-purple-600 text-white">All Algos</button>
            <button onclick="setAlgoFilter('algo1')" id="algoFilterAlgo1" class="algo-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Algo 1</button>
            <button onclick="setAlgoFilter('algo2')" id="algoFilterAlgo2" class="algo-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Algo 2</button>
            <button onclick="setAlgoFilter('algo3')" id="algoFilterAlgo3" class="algo-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">Algo 3</button>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <span class="text-xs text-gray-400">Direction:</span>
            <select id="algoDirection" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="all">All</option>
              <option value="buy">Buy Only</option>
              <option value="sell">Sell Only</option>
            </select>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <span class="text-xs text-gray-400">Show:</span>
            <select id="algoTimeRange" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="active">Currently Active</option>
              <option value="1h">Last 1 Hour</option>
              <option value="4h">Last 4 Hours</option>
              <option value="24h">Last 24 Hours</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- OB/OS Sub-Tabs Panel -->
      <div id="obosCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-4">
          <span class="text-sm font-medium text-yellow-400">üî¥üü¢ OB/OS Filter:</span>
          <div class="flex gap-1">
            <button onclick="setObosFilter('all')" id="obosFilterAll" class="obos-sub-tab px-3 py-1.5 text-xs rounded bg-yellow-600 text-white">All</button>
            <button onclick="setObosFilter('overbought')" id="obosFilterOverbought" class="obos-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">üî¥ Overbought</button>
            <button onclick="setObosFilter('oversold')" id="obosFilterOversold" class="obos-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">üü¢ Oversold</button>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <span class="text-xs text-gray-400">Show:</span>
            <select id="obosTimeRange" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="active">Currently Active</option>
              <option value="1h">Last 1 Hour</option>
              <option value="4h">Last 4 Hours</option>
              <option value="24h">Last 24 Hours</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Zone Rejections Sub-Tabs Panel -->
      <div id="zonesCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-4">
          <span class="text-sm font-medium text-blue-400">üéØ Zone Filter:</span>
          <div class="flex gap-1">
            <button onclick="setZoneFilter('all')" id="zoneFilterAll" class="zone-sub-tab px-3 py-1.5 text-xs rounded bg-blue-600 text-white">All</button>
            <button onclick="setZoneFilter('demand')" id="zoneFilterDemand" class="zone-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">üü¢ Demand</button>
            <button onclick="setZoneFilter('supply')" id="zoneFilterSupply" class="zone-sub-tab px-3 py-1.5 text-xs rounded bg-gray-700 text-gray-300 hover:bg-gray-600">üî¥ Supply</button>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <span class="text-xs text-gray-400">Show:</span>
            <select id="zonesTimeRange" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="renderTable()">
              <option value="active">Currently Active</option>
              <option value="1h">Last 1 Hour</option>
              <option value="4h">Last 4 Hours</option>
              <option value="24h">Last 24 Hours</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Longs Criteria Panel -->
      <div id="longsCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-6 flex-wrap">
          <span class="text-sm font-medium text-green-400">üìà Long Setup Criteria:</span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Zone:</span>
            <select id="longZoneTF" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none">None Required</option>
              <option value="1m">Demand 1m+</option>
              <option value="15m">Demand 15m+</option>
              <option value="1h">Demand 1H+</option>
              <option value="4h" selected>Demand 4H+</option>
              <option value="12h">Demand 12H+</option>
              <option value="1d">Demand 1D+</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">MSS/BOS:</span>
            <select id="longMssBos" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none">None Required</option>
              <option value="bias" selected>Bullish Bias</option>
              <option value="1m">Bullish 1m</option>
              <option value="15m">Bullish 15m</option>
              <option value="1h">Bullish 1H</option>
              <option value="4h">Bullish 4H</option>
              <option value="12h">Bullish 12H</option>
              <option value="1d">Bullish 1D</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">OB/OS:</span>
            <select id="longObOs" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="oversold">Oversold (Buy Signal)</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Caution:</span>
            <select id="longCaution" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="1">Min 1 TF</option>
              <option value="2">Min 2 TF</option>
              <option value="3">Min 3 TF</option>
              <option value="4">Min 4 TF</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Algo:</span>
            <select id="longAlgo" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="algo1">Algo 1 Buy</option>
              <option value="algo2">Algo 2 Buy</option>
              <option value="algo3">Algo 3 Buy</option>
              <option value="any">Any Algo Buy</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Shorts Criteria Panel -->
      <div id="shortsCriteriaPanel" class="hidden bg-gray-750 border-b border-gray-700 px-4 py-3" style="background: #2d3748;">
        <div class="flex items-center gap-6 flex-wrap">
          <span class="text-sm font-medium text-red-400">üìâ Short Setup Criteria:</span>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Zone:</span>
            <select id="shortZoneTF" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none">None Required</option>
              <option value="1m">Supply 1m+</option>
              <option value="15m">Supply 15m+</option>
              <option value="1h">Supply 1H+</option>
              <option value="4h" selected>Supply 4H+</option>
              <option value="12h">Supply 12H+</option>
              <option value="1d">Supply 1D+</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">MSS/BOS:</span>
            <select id="shortMssBos" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none">None Required</option>
              <option value="bias" selected>Bearish Bias</option>
              <option value="1m">Bearish 1m</option>
              <option value="15m">Bearish 15m</option>
              <option value="1h">Bearish 1H</option>
              <option value="4h">Bearish 4H</option>
              <option value="12h">Bearish 12H</option>
              <option value="1d">Bearish 1D</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">OB/OS:</span>
            <select id="shortObOs" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="overbought">Overbought (Sell Signal)</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Caution:</span>
            <select id="shortCaution" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="1">Min 1 TF</option>
              <option value="2">Min 2 TF</option>
              <option value="3">Min 3 TF</option>
              <option value="4">Min 4 TF</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-400">Algo:</span>
            <select id="shortAlgo" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-xs" onchange="applySetupCriteria()">
              <option value="none" selected>None Required</option>
              <option value="algo1">Algo 1 Sell</option>
              <option value="algo2">Algo 2 Sell</option>
              <option value="algo3">Algo 3 Sell</option>
              <option value="any">Any Algo Sell</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Table Area -->
      <div id="mainTableContainer" class="flex-1 overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-900 sticky top-0 z-10">
            <tr class="text-left text-xs text-gray-400">
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('symbol')">Symbol <span id="sort-symbol" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('price')">Price <span id="sort-price" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('change1h')">1h % <span id="sort-change1h" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('change24h')">24h % <span id="sort-change24h" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('change1w')">1w % <span id="sort-change1w" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('mssbos')">MSS/BOS <span id="sort-mssbos" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('zone')">Zone <span id="sort-zone" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('caution')">Caution <span id="sort-caution" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('obos')">OB/OS <span id="sort-obos" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('algo')">Algo <span id="sort-algo" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium cursor-pointer hover:bg-gray-700 select-none" onclick="sortByColumn('updated')">Updated <span id="sort-updated" class="sort-indicator"></span></th>
              <th class="px-3 py-2 font-medium">Links</th>
            </tr>
          </thead>
          <tbody id="dataTable" class="divide-y divide-gray-800"></tbody>
        </table>
        <div id="emptyState" class="hidden py-16 text-center text-gray-500">
          <p class="text-lg">No data yet</p>
          <p class="text-sm mt-1">Waiting for webhooks from TradingView...</p>
        </div>
        <div id="noDataState" class="hidden py-16 text-center text-gray-500">
          <p class="text-lg">No matches found</p>
          <p class="text-sm mt-1">Try adjusting your filters</p>
        </div>
      </div>
      
      <!-- MSS/BOS Grid View -->
      <div id="mssbosGridContainer" class="flex-1 overflow-auto hidden">
        <table class="w-full text-sm" id="mssbosTable">
          <thead class="bg-gray-900 sticky top-0 z-10">
            <tr class="text-left text-xs text-gray-400">
              <th class="px-3 py-2 font-medium sticky left-0 bg-gray-900 z-20">Symbol</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('1m')">1m</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('3m')">3m</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('5m')">5m</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('15m')">15m</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('30m')">30m</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('1h')">1h</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('4h')">4h</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('12h')">12h</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('1d')">1d</th>
              <th class="px-2 py-2 font-medium text-center cursor-pointer hover:bg-gray-700" onclick="filterMssbosByTf('1w')">1w</th>
              <th class="px-3 py-2 font-medium text-center">Score</th>
              <th class="px-3 py-2 font-medium">Links</th>
            </tr>
          </thead>
          <tbody id="mssbosGridBody" class="divide-y divide-gray-800"></tbody>
        </table>
        <div id="mssbosEmptyState" class="hidden py-16 text-center text-gray-500">
          <p class="text-lg">No MSS/BOS data</p>
          <p class="text-sm mt-1">Waiting for webhooks from TradingView...</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Symbol Detail Modal -->
  <div id="detailModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h2 id="detailSymbol" class="text-xl font-bold">BTCUSDT</h2>
          <span id="detailLinks" class="text-lg"></span>
        </div>
        <button onclick="closeDetail()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <div class="flex-1 overflow-auto p-4">
        <div id="tvChart" class="h-96 bg-gray-900 rounded-lg mb-4"></div>
        <div id="detailContent" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>

  <!-- Alert Settings Modal -->
  <div id="alertSettingsModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-bold">Alert Settings</h2>
        <button onclick="closeAlertSettings()" class="text-gray-400 hover:text-white">‚úï</button>
      </div>
      <div id="alertSettingsContent" class="flex-1 overflow-auto p-4"></div>
      <div class="p-4 border-t border-gray-700">
        <button onclick="saveAlertSettings()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium">Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    let dashboardData = [];
    let filteredData = [];
    let currentTab = 'all';
    let currentSection = 'all';
    let alertSettings = [];
    let autoRefreshInterval = null;
    let currentSortColumn = null;
    let currentSortDirection = 'desc'; // 'asc' or 'desc'
    const API = window.location.origin;
    const TIMEFRAMES = ['1m', '3m', '5m', '15m', '30m', '1h', '4h', '12h', '1d', '1w'];

    // Section Filter (All/Crypto/Stocks/Forex)
    function setSection(section) {
      currentSection = section;
      document.querySelectorAll('.section-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-300');
      });
      const active = document.getElementById(`section${section.charAt(0).toUpperCase() + section.slice(1)}`);
      if (active) {
        active.classList.remove('bg-gray-700', 'text-gray-300');
        active.classList.add('bg-blue-600', 'text-white');
      }
      applyFilters();
    }

    // Auto Refresh
    function toggleAutoRefresh() {
      const enabled = document.getElementById('autoRefreshToggle').checked;
      if (enabled) startAutoRefresh();
      else stopAutoRefresh();
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      const seconds = parseInt(document.getElementById('refreshInterval').value);
      if (seconds === 0) return;
      autoRefreshInterval = setInterval(() => { fetchDashboard(); }, seconds * 1000);
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) { clearInterval(autoRefreshInterval); autoRefreshInterval = null; }
    }

    function updateRefreshInterval() {
      const val = document.getElementById('refreshInterval').value;
      if (val === '0') {
        document.getElementById('autoRefreshToggle').checked = false;
        stopAutoRefresh();
      } else if (document.getElementById('autoRefreshToggle').checked) {
        startAutoRefresh();
      }
    }

    // Data Fetching
    async function fetchDashboard() {
      try {
        const res = await fetch(`${API}/api/dashboard`);
        dashboardData = await res.json();
        applyFilters();
        document.getElementById('symbolCount').textContent = dashboardData.filter(d => d.hasData).length;
      } catch (e) { console.error('Fetch error:', e); }
    }

    async function loadSetups() {
      try { const res = await fetch(`${API}/api/setups`); return await res.json(); }
      catch (e) { return { longs: [], shorts: [] }; }
    }

    // Timeframe Helpers
    function getTimeframesAtOrAbove(minTF) {
      const idx = TIMEFRAMES.indexOf(minTF);
      return idx === -1 ? TIMEFRAMES : TIMEFRAMES.slice(idx);
    }

    function getTimeframesAtOrBelow(maxTF) {
      const idx = TIMEFRAMES.indexOf(maxTF);
      return idx === -1 ? TIMEFRAMES : TIMEFRAMES.slice(0, idx + 1);
    }

    function hasZoneInTimeframes(zones, timeframes) {
      return zones && timeframes.some(tf => zones[tf]);
    }

    function hasCautionInTimeframes(cautions, timeframes) {
      return cautions && timeframes.some(tf => cautions[tf]);
    }

    // Sorting
    function sortByColumn(column) {
      // Toggle direction if same column, otherwise default to desc
      if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortColumn = column;
        currentSortDirection = 'desc';
      }
      updateSortIndicators();
      renderTable();
    }

    function updateSortIndicators() {
      // Clear all indicators
      document.querySelectorAll('.sort-indicator').forEach(el => {
        el.classList.remove('asc', 'desc');
      });
      // Set active indicator
      if (currentSortColumn) {
        const indicator = document.getElementById(`sort-${currentSortColumn}`);
        if (indicator) {
          indicator.classList.add(currentSortDirection);
        }
      }
    }

    function getSortValue(item, column) {
      switch (column) {
        case 'symbol': return item.symbol || '';
        case 'price': return item.price || 0;
        case 'change1h': return item.priceChange1h ?? -Infinity;
        case 'change24h': return item.priceChange24h ?? -Infinity;
        case 'change1w': return item.priceChange1w ?? -Infinity;
        case 'mssbos': 
          // Sort by bull count - bear count
          return (item.mssbos?.bullCount || 0) - (item.mssbos?.bearCount || 0);
        case 'zone':
          // Count active zones
          const dz = item.supplydemand?.demandZones || {};
          const sz = item.supplydemand?.supplyZones || {};
          return Object.values(dz).filter(Boolean).length + Object.values(sz).filter(Boolean).length;
        case 'caution': return item.momentum?.cautionCount || 0;
        case 'obos':
          // OB = 1, OS = -1, both = 2, none = 0
          let obosScore = 0;
          if (item.multialgo?.dotsGreen) obosScore += 1;
          if (item.multialgo?.dotsRed) obosScore += 1;
          return obosScore;
        case 'algo':
          // Count active algo signals
          let algoCount = 0;
          if (item.multialgo?.algo1Buy || item.multialgo?.algo1Sell) algoCount++;
          if (item.multialgo?.algo2Buy || item.multialgo?.algo2Sell) algoCount++;
          if (item.multialgo?.algo3Buy || item.multialgo?.algo3Sell) algoCount++;
          return algoCount;
        case 'updated': return item.lastUpdated || 0;
        default: return 0;
      }
    }

    function sortData(data) {
      if (!currentSortColumn) return data;
      
      return [...data].sort((a, b) => {
        let aVal = getSortValue(a, currentSortColumn);
        let bVal = getSortValue(b, currentSortColumn);
        
        // Handle string comparison
        if (typeof aVal === 'string' && typeof bVal === 'string') {
          return currentSortDirection === 'asc' 
            ? aVal.localeCompare(bVal) 
            : bVal.localeCompare(aVal);
        }
        
        // Handle numeric comparison
        if (currentSortDirection === 'asc') {
          return aVal - bVal;
        } else {
          return bVal - aVal;
        }
      });
    }

    // Filtering
    function getFilters() {
      return {
        demand: document.getElementById('fDemand').checked,
        demandTF: document.getElementById('fDemandTF').value,
        supply: document.getElementById('fSupply').checked,
        supplyTF: document.getElementById('fSupplyTF').value,
        demandRej: document.getElementById('fDemandRej').checked,
        supplyRej: document.getElementById('fSupplyRej').checked,
        bullBias: document.getElementById('fBullBias').checked,
        bearBias: document.getElementById('fBearBias').checked,
        bullTF: document.getElementById('fBullTF').checked,
        bullTFSelect: document.getElementById('fBullTFSelect').value,
        bearTF: document.getElementById('fBearTF').checked,
        bearTFSelect: document.getElementById('fBearTFSelect').value,
        hasCaution: document.getElementById('fHasCaution').checked,
        cautionTF: document.getElementById('fCautionTF').value,
        minCaution: parseInt(document.getElementById('fMinCaution').value) || 0,
        overbought: document.getElementById('fOverbought').checked,
        oversold: document.getElementById('fOversold').checked,
        algo1Buy: document.getElementById('fAlgo1Buy').checked,
        algo1Sell: document.getElementById('fAlgo1Sell').checked,
        algo2Buy: document.getElementById('fAlgo2Buy').checked,
        algo2Sell: document.getElementById('fAlgo2Sell').checked,
        algo3Buy: document.getElementById('fAlgo3Buy').checked,
        algo3Sell: document.getElementById('fAlgo3Sell').checked
      };
    }

    function applyFilters() {
      const f = getFilters();
      filteredData = dashboardData.filter(item => {
        // Section filter (All/Crypto/Stocks/Forex)
        if (currentSection !== 'all') {
          const itemSection = (item.section || 'Other').toLowerCase();
          if (itemSection !== currentSection.toLowerCase()) return false;
        }
        if (!item.hasData && currentTab !== 'watchlist') return false;
        if (f.demand && !hasZoneInTimeframes(item.supplydemand?.demandZones, getTimeframesAtOrAbove(f.demandTF))) return false;
        if (f.supply && !hasZoneInTimeframes(item.supplydemand?.supplyZones, getTimeframesAtOrAbove(f.supplyTF))) return false;
        if (f.demandRej && !item.supplydemand?.demandRejection) return false;
        if (f.supplyRej && !item.supplydemand?.supplyRejection) return false;
        if (f.bullBias && item.mssbos?.bias !== 'BULL') return false;
        if (f.bearBias && item.mssbos?.bias !== 'BEAR') return false;
        if (f.bullTF && item.mssbos?.timeframes?.[f.bullTFSelect]?.direction !== 'BULL') return false;
        if (f.bearTF && item.mssbos?.timeframes?.[f.bearTFSelect]?.direction !== 'BEAR') return false;
        if (f.hasCaution && !hasCautionInTimeframes(item.momentum?.cautions, getTimeframesAtOrBelow(f.cautionTF))) return false;
        if (f.minCaution > 0 && (item.momentum?.cautionCount || 0) < f.minCaution) return false;
        if (f.overbought && !item.multialgo?.dotsGreen) return false;
        if (f.oversold && !item.multialgo?.dotsRed) return false;
        if (f.algo1Buy && !item.multialgo?.algo1Buy) return false;
        if (f.algo1Sell && !item.multialgo?.algo1Sell) return false;
        if (f.algo2Buy && !item.multialgo?.algo2Buy) return false;
        if (f.algo2Sell && !item.multialgo?.algo2Sell) return false;
        if (f.algo3Buy && !item.multialgo?.algo3Buy) return false;
        if (f.algo3Sell && !item.multialgo?.algo3Sell) return false;
        return true;
      });
      if (currentTab === 'mssbos') {
        renderMssBosGrid();
      } else {
        renderTable();
      }
    }

    // Get Longs/Shorts based on custom criteria
    function getSetupCriteria(direction) {
      if (direction === 'long') {
        return {
          zoneTF: document.getElementById('longZoneTF').value,
          mssbos: document.getElementById('longMssBos').value,
          obos: document.getElementById('longObOs').value,
          caution: document.getElementById('longCaution').value,
          algo: document.getElementById('longAlgo').value
        };
      } else {
        return {
          zoneTF: document.getElementById('shortZoneTF').value,
          mssbos: document.getElementById('shortMssBos').value,
          obos: document.getElementById('shortObOs').value,
          caution: document.getElementById('shortCaution').value,
          algo: document.getElementById('shortAlgo').value
        };
      }
    }

    function filterBySetupCriteria(data, direction) {
      const c = getSetupCriteria(direction);
      
      return data.filter(item => {
        if (!item.hasData) return false;
        
        // Zone check
        if (c.zoneTF !== 'none') {
          const zones = direction === 'long' ? item.supplydemand?.demandZones : item.supplydemand?.supplyZones;
          if (!hasZoneInTimeframes(zones, getTimeframesAtOrAbove(c.zoneTF))) return false;
        }
        
        // MSS/BOS check
        if (c.mssbos !== 'none') {
          const targetBias = direction === 'long' ? 'BULL' : 'BEAR';
          if (c.mssbos === 'bias') {
            if (item.mssbos?.bias !== targetBias) return false;
          } else {
            if (item.mssbos?.timeframes?.[c.mssbos]?.direction !== targetBias) return false;
          }
        }
        
        // OB/OS check
        if (c.obos !== 'none') {
          if (direction === 'long' && c.obos === 'oversold' && !item.multialgo?.dotsRed) return false;
          if (direction === 'short' && c.obos === 'overbought' && !item.multialgo?.dotsGreen) return false;
        }
        
        // Caution check
        if (c.caution !== 'none') {
          const minCaution = parseInt(c.caution);
          if ((item.momentum?.cautionCount || 0) < minCaution) return false;
        }
        
        // Algo check
        if (c.algo !== 'none') {
          if (direction === 'long') {
            if (c.algo === 'algo1' && !item.multialgo?.algo1Buy) return false;
            if (c.algo === 'algo2' && !item.multialgo?.algo2Buy) return false;
            if (c.algo === 'algo3' && !item.multialgo?.algo3Buy) return false;
            if (c.algo === 'any' && !item.multialgo?.algo1Buy && !item.multialgo?.algo2Buy && !item.multialgo?.algo3Buy) return false;
          } else {
            if (c.algo === 'algo1' && !item.multialgo?.algo1Sell) return false;
            if (c.algo === 'algo2' && !item.multialgo?.algo2Sell) return false;
            if (c.algo === 'algo3' && !item.multialgo?.algo3Sell) return false;
            if (c.algo === 'any' && !item.multialgo?.algo1Sell && !item.multialgo?.algo2Sell && !item.multialgo?.algo3Sell) return false;
          }
        }
        
        return true;
      });
    }

    // Filter for Algo Signals tab
    function filterAlgoSignals(data) {
      const algoFilter = currentAlgoFilter;
      const direction = document.getElementById('algoDirection')?.value || 'all';
      const timeRange = document.getElementById('algoTimeRange')?.value || 'active';
      
      // Calculate time threshold based on time range
      const now = Date.now();
      let timeThreshold = 0;
      if (timeRange === '1h') timeThreshold = now - (60 * 60 * 1000);
      else if (timeRange === '4h') timeThreshold = now - (4 * 60 * 60 * 1000);
      else if (timeRange === '24h') timeThreshold = now - (24 * 60 * 60 * 1000);
      // 'active' means currently active (no time filter beyond sticky period)
      
      return data.filter(item => {
        if (!item.multialgo) return false;
        
        const a = item.multialgo;
        let hasSignal = false;
        let latestSignalTime = 0;
        
        // Helper to check if signal is within time range
        const isWithinTimeRange = (signalTime) => {
          if (timeRange === 'active') return true; // Server handles sticky duration
          return signalTime && signalTime >= timeThreshold;
        };
        
        // Check based on algo filter
        if (algoFilter === 'all') {
          if (direction === 'all') {
            hasSignal = (a.algo1Buy && isWithinTimeRange(a.algo1BuyTime)) || 
                        (a.algo1Sell && isWithinTimeRange(a.algo1SellTime)) || 
                        (a.algo2Buy && isWithinTimeRange(a.algo2BuyTime)) || 
                        (a.algo2Sell && isWithinTimeRange(a.algo2SellTime)) || 
                        (a.algo3Buy && isWithinTimeRange(a.algo3BuyTime)) || 
                        (a.algo3Sell && isWithinTimeRange(a.algo3SellTime));
            latestSignalTime = Math.max(a.algo1BuyTime || 0, a.algo1SellTime || 0, a.algo2BuyTime || 0, a.algo2SellTime || 0, a.algo3BuyTime || 0, a.algo3SellTime || 0);
          } else if (direction === 'buy') {
            hasSignal = (a.algo1Buy && isWithinTimeRange(a.algo1BuyTime)) || 
                        (a.algo2Buy && isWithinTimeRange(a.algo2BuyTime)) || 
                        (a.algo3Buy && isWithinTimeRange(a.algo3BuyTime));
            latestSignalTime = Math.max(a.algo1BuyTime || 0, a.algo2BuyTime || 0, a.algo3BuyTime || 0);
          } else if (direction === 'sell') {
            hasSignal = (a.algo1Sell && isWithinTimeRange(a.algo1SellTime)) || 
                        (a.algo2Sell && isWithinTimeRange(a.algo2SellTime)) || 
                        (a.algo3Sell && isWithinTimeRange(a.algo3SellTime));
            latestSignalTime = Math.max(a.algo1SellTime || 0, a.algo2SellTime || 0, a.algo3SellTime || 0);
          }
        } else if (algoFilter === 'algo1') {
          if (direction === 'all') {
            hasSignal = (a.algo1Buy && isWithinTimeRange(a.algo1BuyTime)) || (a.algo1Sell && isWithinTimeRange(a.algo1SellTime));
            latestSignalTime = Math.max(a.algo1BuyTime || 0, a.algo1SellTime || 0);
          } else if (direction === 'buy') {
            hasSignal = a.algo1Buy && isWithinTimeRange(a.algo1BuyTime);
            latestSignalTime = a.algo1BuyTime || 0;
          } else if (direction === 'sell') {
            hasSignal = a.algo1Sell && isWithinTimeRange(a.algo1SellTime);
            latestSignalTime = a.algo1SellTime || 0;
          }
        } else if (algoFilter === 'algo2') {
          if (direction === 'all') {
            hasSignal = (a.algo2Buy && isWithinTimeRange(a.algo2BuyTime)) || (a.algo2Sell && isWithinTimeRange(a.algo2SellTime));
            latestSignalTime = Math.max(a.algo2BuyTime || 0, a.algo2SellTime || 0);
          } else if (direction === 'buy') {
            hasSignal = a.algo2Buy && isWithinTimeRange(a.algo2BuyTime);
            latestSignalTime = a.algo2BuyTime || 0;
          } else if (direction === 'sell') {
            hasSignal = a.algo2Sell && isWithinTimeRange(a.algo2SellTime);
            latestSignalTime = a.algo2SellTime || 0;
          }
        } else if (algoFilter === 'algo3') {
          if (direction === 'all') {
            hasSignal = (a.algo3Buy && isWithinTimeRange(a.algo3BuyTime)) || (a.algo3Sell && isWithinTimeRange(a.algo3SellTime));
            latestSignalTime = Math.max(a.algo3BuyTime || 0, a.algo3SellTime || 0);
          } else if (direction === 'buy') {
            hasSignal = a.algo3Buy && isWithinTimeRange(a.algo3BuyTime);
            latestSignalTime = a.algo3BuyTime || 0;
          } else if (direction === 'sell') {
            hasSignal = a.algo3Sell && isWithinTimeRange(a.algo3SellTime);
            latestSignalTime = a.algo3SellTime || 0;
          }
        }
        
        // Store latest signal time for sorting
        item._latestSignalTime = latestSignalTime;
        
        return hasSignal;
      }).sort((a, b) => (b._latestSignalTime || 0) - (a._latestSignalTime || 0));
    }

    // Filter for OB/OS tab
    function filterObosSignals(data) {
      const obosFilter = currentObosFilter;
      const timeRange = document.getElementById('obosTimeRange')?.value || 'active';
      
      const now = Date.now();
      let timeThreshold = 0;
      if (timeRange === '1h') timeThreshold = now - (60 * 60 * 1000);
      else if (timeRange === '4h') timeThreshold = now - (4 * 60 * 60 * 1000);
      else if (timeRange === '24h') timeThreshold = now - (24 * 60 * 60 * 1000);
      
      return data.filter(item => {
        if (!item.multialgo) return false;
        
        const a = item.multialgo;
        let hasSignal = false;
        let latestSignalTime = 0;
        
        const isWithinTimeRange = (signalTime) => {
          if (timeRange === 'active') return true;
          return signalTime && signalTime >= timeThreshold;
        };
        
        if (obosFilter === 'all') {
          hasSignal = (a.dotsGreen && isWithinTimeRange(a.dotsGreenTime)) || (a.dotsRed && isWithinTimeRange(a.dotsRedTime));
          latestSignalTime = Math.max(a.dotsGreenTime || 0, a.dotsRedTime || 0);
        } else if (obosFilter === 'overbought') {
          hasSignal = a.dotsGreen && isWithinTimeRange(a.dotsGreenTime);
          latestSignalTime = a.dotsGreenTime || 0;
        } else if (obosFilter === 'oversold') {
          hasSignal = a.dotsRed && isWithinTimeRange(a.dotsRedTime);
          latestSignalTime = a.dotsRedTime || 0;
        }
        
        item._latestSignalTime = latestSignalTime;
        return hasSignal;
      }).sort((a, b) => (b._latestSignalTime || 0) - (a._latestSignalTime || 0));
    }

    // Filter for Zone Rejections tab
    function filterZoneRejections(data) {
      const zoneFilter = currentZoneFilter;
      const timeRange = document.getElementById('zonesTimeRange')?.value || 'active';
      
      const now = Date.now();
      let timeThreshold = 0;
      if (timeRange === '1h') timeThreshold = now - (60 * 60 * 1000);
      else if (timeRange === '4h') timeThreshold = now - (4 * 60 * 60 * 1000);
      else if (timeRange === '24h') timeThreshold = now - (24 * 60 * 60 * 1000);
      
      return data.filter(item => {
        if (!item.supplydemand) return false;
        
        const sd = item.supplydemand;
        let hasSignal = false;
        let latestSignalTime = 0;
        
        const isWithinTimeRange = (signalTime) => {
          if (timeRange === 'active') return true;
          return signalTime && signalTime >= timeThreshold;
        };
        
        if (zoneFilter === 'all') {
          hasSignal = (sd.demandRejection && isWithinTimeRange(sd.demandRejectionTime)) || (sd.supplyRejection && isWithinTimeRange(sd.supplyRejectionTime));
          latestSignalTime = Math.max(sd.demandRejectionTime || 0, sd.supplyRejectionTime || 0);
        } else if (zoneFilter === 'demand') {
          hasSignal = sd.demandRejection && isWithinTimeRange(sd.demandRejectionTime);
          latestSignalTime = sd.demandRejectionTime || 0;
        } else if (zoneFilter === 'supply') {
          hasSignal = sd.supplyRejection && isWithinTimeRange(sd.supplyRejectionTime);
          latestSignalTime = sd.supplyRejectionTime || 0;
        }
        
        item._latestSignalTime = latestSignalTime;
        return hasSignal;
      }).sort((a, b) => (b._latestSignalTime || 0) - (a._latestSignalTime || 0));
    }

    function applySetupCriteria() {
      renderTable();
    }

    function applyPreset(preset) {
      clearFilters();
      if (preset === 'long') {
        document.getElementById('fDemand').checked = true;
        document.getElementById('fBullBias').checked = true;
        document.getElementById('fHasCaution').checked = true;
      } else if (preset === 'short') {
        document.getElementById('fSupply').checked = true;
        document.getElementById('fBearBias').checked = true;
        document.getElementById('fHasCaution').checked = true;
      } else if (preset === 'confluence') {
        document.getElementById('fMinCaution').value = 3;
      }
      applyFilters();
    }

    function clearFilters() {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => { if (cb.id !== 'autoRefreshToggle') cb.checked = false; });
      document.getElementById('fMinCaution').value = 0;
      document.getElementById('fDemandTF').value = '4h';
      document.getElementById('fSupplyTF').value = '4h';
      document.getElementById('fBullTFSelect').value = '12h';
      document.getElementById('fBearTFSelect').value = '12h';
      document.getElementById('fCautionTF').value = '4h';
      applyFilters();
    }

    // Rendering
    async function renderTable() {
      const tbody = document.getElementById('dataTable');
      const empty = document.getElementById('emptyState');
      const noData = document.getElementById('noDataState');
      let data = filteredData;

      if (currentTab === 'longs') { data = filterBySetupCriteria(dashboardData, 'long'); }
      else if (currentTab === 'shorts') { data = filterBySetupCriteria(dashboardData, 'short'); }
      else if (currentTab === 'algo') { data = filterAlgoSignals(dashboardData); }
      else if (currentTab === 'obos') { data = filterObosSignals(dashboardData); }
      else if (currentTab === 'zones') { data = filterZoneRejections(dashboardData); }

      // Apply sorting
      data = sortData(data);

      if (dashboardData.length === 0) { tbody.innerHTML = ''; empty.classList.remove('hidden'); noData.classList.add('hidden'); return; }
      if (data.length === 0) { tbody.innerHTML = ''; empty.classList.add('hidden'); noData.classList.remove('hidden'); return; }
      empty.classList.add('hidden'); noData.classList.add('hidden');

      tbody.innerHTML = data.map(item => `
        <tr class="table-row cursor-pointer" onclick="showDetail('${item.symbol}')">
          <td class="px-3 py-2"><span class="font-semibold">${item.symbol}</span>${!item.hasData ? '<span class="text-xs text-gray-500 ml-1">(no data)</span>' : ''}</td>
          <td class="px-3 py-2 font-mono">${formatPrice(item.price)}</td>
          <td class="px-3 py-2">${formatChange(item.priceChange1h)}</td>
          <td class="px-3 py-2">${formatChange(item.priceChange24h)}</td>
          <td class="px-3 py-2">${formatChange(item.priceChange1w)}</td>
          <td class="px-3 py-2">${renderMssBos(item.mssbos)}</td>
          <td class="px-3 py-2">${renderZone(item.supplydemand)}</td>
          <td class="px-3 py-2">${renderCaution(item.momentum)}</td>
          <td class="px-3 py-2">${renderObOs(item.multialgo)}</td>
          <td class="px-3 py-2">${renderAlgo(item.multialgo)}</td>
          <td class="px-3 py-2 text-xs text-gray-500">${formatTime(item.lastUpdated)}</td>
          <td class="px-3 py-2">${renderLinks(item.symbol)}</td>
        </tr>
      `).join('');
    }

    function renderLinks(symbol) {
      const kcexSymbol = symbol.replace('USDT', '_USDT');
      return `<a href="https://www.tradingview.com/chart/?symbol=BINANCE:${symbol}" target="_blank" onclick="event.stopPropagation()" class="hover:opacity-70" title="Open in TradingView">üì∫</a> <a href="https://www.kcex.com/futures/exchange/${kcexSymbol}?type=linear_swap" target="_blank" onclick="event.stopPropagation()" class="hover:opacity-70" title="Trade on KCEX"><img src="https://www.kcex.com/favicon.ico" alt="K" style="width:16px;height:16px;display:inline-block;vertical-align:middle;"></a>`;
    }

    function renderObOs(a) {
      if (!a) return '<span class="text-gray-500">-</span>';
      const parts = [];
      const formatSignalTime = (ts) => {
        if (!ts) return '';
        const mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 1) return ' (now)';
        if (mins < 60) return ` (${mins}m)`;
        const hrs = Math.floor(mins / 60);
        return ` (${hrs}h)`;
      };
      if (a.dotsGreen) parts.push(`<span class="text-green-400" title="15M+1H Overbought${formatSignalTime(a.dotsGreenTime)}">OB${formatSignalTime(a.dotsGreenTime)}</span>`);
      if (a.dotsRed) parts.push(`<span class="text-red-400" title="15M+1H Oversold${formatSignalTime(a.dotsRedTime)}">OS${formatSignalTime(a.dotsRedTime)}</span>`);
      return parts.length ? parts.join(' ') : '<span class="text-gray-500">-</span>';
    }

    function renderMssBos(m) {
      if (!m) return '<span class="text-gray-500">-</span>';
      const cls = m.bias === 'BULL' ? 'badge-bull' : m.bias === 'BEAR' ? 'badge-bear' : 'badge-neutral';
      return `<span class="badge ${cls}">${m.bias || 'N/A'}</span> <span class="text-xs text-gray-400">${m.bullCount}‚Üë${m.bearCount}‚Üì</span>`;
    }

    function renderZone(sd) {
      if (!sd) return '<span class="text-gray-500">-</span>';
      const parts = [];
      const formatSignalTime = (ts) => {
        if (!ts) return '';
        const mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 1) return ' (now)';
        if (mins < 60) return ` (${mins}m)`;
        const hrs = Math.floor(mins / 60);
        return ` (${hrs}h)`;
      };
      const demandTFs = sd.demandZones ? Object.entries(sd.demandZones).filter(([k,v]) => v).map(([k]) => k) : [];
      const supplyTFs = sd.supplyZones ? Object.entries(sd.supplyZones).filter(([k,v]) => v).map(([k]) => k) : [];
      if (demandTFs.length) parts.push(`<span class="badge badge-bull">D:${demandTFs.slice(0,3).join(',')}</span>`);
      if (supplyTFs.length) parts.push(`<span class="badge badge-bear">S:${supplyTFs.slice(0,3).join(',')}</span>`);
      if (sd.demandRejection) parts.push(`<span class="text-xs text-green-400" title="Demand Rejection${formatSignalTime(sd.demandRejectionTime)}">DR${formatSignalTime(sd.demandRejectionTime)}</span>`);
      if (sd.supplyRejection) parts.push(`<span class="text-xs text-red-400" title="Supply Rejection${formatSignalTime(sd.supplyRejectionTime)}">SR${formatSignalTime(sd.supplyRejectionTime)}</span>`);
      return parts.length ? parts.join(' ') : '<span class="text-gray-500">-</span>';
    }

    function renderCaution(m) {
      if (!m || !m.cautionCount) return '<span class="text-gray-500">-</span>';
      return `<span class="badge badge-caution">${m.cautionCount} TF</span>`;
    }

    function renderAlgo(a) {
      if (!a) return '<span class="text-gray-500">-</span>';
      const parts = [];
      const formatSignalTime = (ts) => {
        if (!ts) return '';
        const mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 1) return ' (now)';
        if (mins < 60) return ` (${mins}m)`;
        const hrs = Math.floor(mins / 60);
        return ` (${hrs}h)`;
      };
      if (a.algo1Buy) parts.push(`<span class="text-xs text-green-400" title="Algo 1 Buy${formatSignalTime(a.algo1BuyTime)}">A1${formatSignalTime(a.algo1BuyTime)}</span>`);
      if (a.algo1Sell) parts.push(`<span class="text-xs text-red-400" title="Algo 1 Sell${formatSignalTime(a.algo1SellTime)}">A1${formatSignalTime(a.algo1SellTime)}</span>`);
      if (a.algo2Buy) parts.push(`<span class="text-xs text-green-400" title="Algo 2 Buy${formatSignalTime(a.algo2BuyTime)}">A2${formatSignalTime(a.algo2BuyTime)}</span>`);
      if (a.algo2Sell) parts.push(`<span class="text-xs text-red-400" title="Algo 2 Sell${formatSignalTime(a.algo2SellTime)}">A2${formatSignalTime(a.algo2SellTime)}</span>`);
      if (a.algo3Buy) parts.push(`<span class="text-xs text-green-400" title="Algo 3 Buy${formatSignalTime(a.algo3BuyTime)}">A3${formatSignalTime(a.algo3BuyTime)}</span>`);
      if (a.algo3Sell) parts.push(`<span class="text-xs text-red-400" title="Algo 3 Sell${formatSignalTime(a.algo3SellTime)}">A3${formatSignalTime(a.algo3SellTime)}</span>`);
      return parts.length ? parts.join(' ') : '<span class="text-gray-500">-</span>';
    }

    // Detail Modal
    function showDetail(symbol) {
      const item = dashboardData.find(d => d.symbol === symbol);
      if (!item) return;
      document.getElementById('detailSymbol').textContent = symbol;
      document.getElementById('detailLinks').innerHTML = renderLinks(symbol);
      document.getElementById('detailModal').classList.remove('hidden');
      const tvContainer = document.getElementById('tvChart');
      tvContainer.innerHTML = '';
      new TradingView.widget({ container_id: 'tvChart', symbol: `BINANCE:${symbol}`, interval: '60', theme: 'dark', style: '1', locale: 'en', toolbar_bg: '#1f2937', enable_publishing: false, hide_side_toolbar: false, allow_symbol_change: true, height: 384, width: '100%' });
      document.getElementById('detailContent').innerHTML = `
        <div class="bg-gray-900 rounded-lg p-4"><h3 class="font-medium mb-3">MSS/BOS Analysis</h3>${item.mssbos ? `<div class="grid grid-cols-10 gap-1">${TIMEFRAMES.map(tf => { const tfData = item.mssbos.timeframes?.[tf]; const dir = tfData?.direction || (typeof tfData === 'string' ? tfData : null); const signalType = tfData?.signalType || ''; const cls = dir === 'BULL' ? 'tf-bull' : dir === 'BEAR' ? 'tf-bear' : 'tf-none'; const label = signalType ? signalType : tf; return `<div class="tf-cell ${cls}" title="${dir || 'No signal'} ${signalType}">${label}</div>`; }).join('')}</div><p class="text-xs text-gray-400 mt-2">Bias: <span class="${item.mssbos.bias === 'BULL' ? 'text-green-400' : item.mssbos.bias === 'BEAR' ? 'text-red-400' : 'text-gray-400'}">${item.mssbos.bias || 'N/A'}</span> (${item.mssbos.bullCount || 0}‚Üë ${item.mssbos.bearCount || 0}‚Üì)</p>` : '<p class="text-gray-500">No data</p>'}</div>
        <div class="bg-gray-900 rounded-lg p-4"><h3 class="font-medium mb-3">Supply/Demand Zones</h3>${item.supplydemand ? `<p class="text-xs text-gray-400 mb-1">Demand</p><div class="grid grid-cols-10 gap-1 mb-2">${TIMEFRAMES.map(tf => `<div class="tf-cell ${item.supplydemand.demandZones?.[tf] ? 'tf-bull' : 'tf-none'}">${tf}</div>`).join('')}</div><p class="text-xs text-gray-400 mb-1">Supply</p><div class="grid grid-cols-10 gap-1">${TIMEFRAMES.map(tf => `<div class="tf-cell ${item.supplydemand.supplyZones?.[tf] ? 'tf-bear' : 'tf-none'}">${tf}</div>`).join('')}</div>` : '<p class="text-gray-500">No data</p>'}</div>
        <div class="bg-gray-900 rounded-lg p-4"><h3 class="font-medium mb-3">Momentum & Caution</h3>${item.momentum ? `<p class="text-xs text-gray-400 mb-1">Caution (${item.momentum.cautionCount || 0})</p><div class="grid grid-cols-10 gap-1">${TIMEFRAMES.map(tf => `<div class="tf-cell" style="${item.momentum.cautions?.[tf] ? 'background:rgba(251,191,36,0.3);color:#fbbf24;' : 'background:rgba(75,85,99,0.3);color:#6b7280;'}">${tf}</div>`).join('')}</div>` : '<p class="text-gray-500">No data</p>'}</div>
        <div class="bg-gray-900 rounded-lg p-4"><h3 class="font-medium mb-3">Multi-Algo Signals</h3>${item.multialgo ? `<div class="grid grid-cols-2 gap-2"><div class="text-center p-2 rounded ${item.multialgo.dotsGreen ? 'bg-green-600/20' : 'bg-gray-700'}"><span class="text-sm font-medium">15M+1H Overbought</span></div><div class="text-center p-2 rounded ${item.multialgo.dotsRed ? 'bg-red-600/20' : 'bg-gray-700'}"><span class="text-sm font-medium">15M+1H Oversold</span></div><div class="text-center p-2 rounded ${item.multialgo.algo1Buy ? 'bg-green-600/20' : item.multialgo.algo1Sell ? 'bg-red-600/20' : 'bg-gray-700'}"><span class="text-xs">Algo 1: ${item.multialgo.algo1Buy ? 'BUY' : item.multialgo.algo1Sell ? 'SELL' : '-'}</span></div><div class="text-center p-2 rounded ${item.multialgo.algo2Buy ? 'bg-green-600/20' : item.multialgo.algo2Sell ? 'bg-red-600/20' : 'bg-gray-700'}"><span class="text-xs">Algo 2: ${item.multialgo.algo2Buy ? 'BUY' : item.multialgo.algo2Sell ? 'SELL' : '-'}</span></div><div class="text-center p-2 rounded ${item.multialgo.algo3Buy ? 'bg-green-600/20' : item.multialgo.algo3Sell ? 'bg-red-600/20' : 'bg-gray-700'}"><span class="text-xs">Algo 3: ${item.multialgo.algo3Buy ? 'BUY' : item.multialgo.algo3Sell ? 'SELL' : '-'}</span></div></div>` : '<p class="text-gray-500">No data</p>'}</div>`;
    }

    function closeDetail() { document.getElementById('detailModal').classList.add('hidden'); }

    // ESC key to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeDetail();
        document.getElementById('alertSettingsModal').classList.add('hidden');
      }
    });

    // Alert Settings
    async function openAlertSettings() {
      try {
        const res = await fetch(`${API}/api/alert-settings`);
        alertSettings = await res.json();
        document.getElementById('alertSettingsContent').innerHTML = alertSettings.map(s => {
          let displayName = s.alert_type.replace(/_/g, ' ');
          if (s.alert_type === 'DOTS_GREEN') displayName = '15M + 1H OVERBOUGHT';
          if (s.alert_type === 'DOTS_RED') displayName = '15M + 1H OVERSOLD';
          if (s.alert_type === 'SQUARES_GREEN' || s.alert_type === 'SQUARES_RED') return '';
          return `<div class="flex items-center justify-between py-2 border-b border-gray-700"><span class="text-sm">${displayName}</span><label class="flex items-center gap-2"><input type="checkbox" data-type="${s.alert_type}" ${s.show_in_panel ? 'checked' : ''} class="alert-toggle custom-check"><span class="text-xs text-gray-400">Show</span></label></div>`;
        }).filter(s => s).join('');
        document.getElementById('alertSettingsModal').classList.remove('hidden');
      } catch (e) { console.error(e); }
    }

    function closeAlertSettings() { document.getElementById('alertSettingsModal').classList.add('hidden'); }

    async function saveAlertSettings() {
      const toggles = document.querySelectorAll('.alert-toggle');
      for (const toggle of toggles) {
        await fetch(`${API}/api/alert-settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ alert_type: toggle.dataset.type, show_in_panel: toggle.checked }) });
      }
      closeAlertSettings();
    }

    // Tabs
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => { t.classList.remove('border-blue-500', 'text-blue-400'); t.classList.add('border-transparent', 'text-gray-400'); });
      const active = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (active) { active.classList.remove('border-transparent', 'text-gray-400'); active.classList.add('border-blue-500', 'text-blue-400'); }
      
      // Show/hide criteria panels
      document.getElementById('longsCriteriaPanel').classList.toggle('hidden', tab !== 'longs');
      document.getElementById('shortsCriteriaPanel').classList.toggle('hidden', tab !== 'shorts');
      document.getElementById('algoCriteriaPanel').classList.toggle('hidden', tab !== 'algo');
      document.getElementById('obosCriteriaPanel').classList.toggle('hidden', tab !== 'obos');
      document.getElementById('zonesCriteriaPanel').classList.toggle('hidden', tab !== 'zones');
      document.getElementById('mssbosCriteriaPanel').classList.toggle('hidden', tab !== 'mssbos');
      
      // Show/hide table vs grid view
      document.getElementById('mainTableContainer').classList.toggle('hidden', tab === 'mssbos');
      document.getElementById('mssbosGridContainer').classList.toggle('hidden', tab !== 'mssbos');
      
      if (tab === 'mssbos') {
        renderMssBosGrid();
      } else {
        renderTable();
      }
    }

    // OB/OS sub-tab filter
    let currentObosFilter = 'all';
    function setObosFilter(filter) {
      currentObosFilter = filter;
      document.querySelectorAll('.obos-sub-tab').forEach(t => {
        t.classList.remove('bg-yellow-600', 'text-white');
        t.classList.add('bg-gray-700', 'text-gray-300');
      });
      const active = document.getElementById(`obosFilter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
      if (active) {
        active.classList.remove('bg-gray-700', 'text-gray-300');
        active.classList.add('bg-yellow-600', 'text-white');
      }
      renderTable();
    }

    // Zone Rejection sub-tab filter
    let currentZoneFilter = 'all';
    function setZoneFilter(filter) {
      currentZoneFilter = filter;
      document.querySelectorAll('.zone-sub-tab').forEach(t => {
        t.classList.remove('bg-blue-600', 'text-white');
        t.classList.add('bg-gray-700', 'text-gray-300');
      });
      const active = document.getElementById(`zoneFilter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
      if (active) {
        active.classList.remove('bg-gray-700', 'text-gray-300');
        active.classList.add('bg-blue-600', 'text-white');
      }
      renderTable();
    }

    // Algo sub-tab filter
    let currentAlgoFilter = 'all';
    function setAlgoFilter(filter) {
      currentAlgoFilter = filter;
      document.querySelectorAll('.algo-sub-tab').forEach(t => {
        t.classList.remove('bg-purple-600', 'text-white');
        t.classList.add('bg-gray-700', 'text-gray-300');
      });
      const active = document.getElementById(`algoFilter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
      if (active) {
        active.classList.remove('bg-gray-700', 'text-gray-300');
        active.classList.add('bg-purple-600', 'text-white');
      }
      renderTable();
    }

    // MSS/BOS Grid Functions
    function filterMssbosByTf(tf) {
      document.getElementById('mssbosTimeframe').value = tf;
      renderMssBosGrid();
    }

    function getMssBosScore(item, primaryTf) {
      if (!item.mssbos?.timeframes) return { score: 0, bullCount: 0, bearCount: 0 };
      
      const tfs = item.mssbos.timeframes;
      let bullCount = 0;
      let bearCount = 0;
      
      TIMEFRAMES.forEach(tf => {
        const dir = tfs[tf]?.direction || (typeof tfs[tf] === 'string' ? tfs[tf] : null);
        if (dir === 'BULL') bullCount++;
        else if (dir === 'BEAR') bearCount++;
      });
      
      // Score is based on primary TF direction + count of aligned TFs
      const primaryDir = tfs[primaryTf]?.direction || (typeof tfs[primaryTf] === 'string' ? tfs[primaryTf] : null);
      let score = 0;
      
      if (primaryDir === 'BULL') {
        score = 100 + bullCount; // Bullish on primary TF gets base 100 + bull count
      } else if (primaryDir === 'BEAR') {
        score = -100 - bearCount; // Bearish on primary TF gets base -100 - bear count
      } else {
        score = bullCount - bearCount; // No signal on primary TF, just use net count
      }
      
      return { score, bullCount, bearCount, primaryDir };
    }

    function renderMssBosGrid() {
      const tbody = document.getElementById('mssbosGridBody');
      const empty = document.getElementById('mssbosEmptyState');
      const primaryTf = document.getElementById('mssbosTimeframe').value;
      const direction = document.getElementById('mssbosDirection').value;
      const sortOrder = document.getElementById('mssbosSort').value;
      
      // Filter data - must have MSS/BOS data
      let data = dashboardData.filter(item => item.mssbos?.timeframes);
      
      // Apply section filter
      if (currentSection !== 'all') {
        data = data.filter(item => (item.section || 'Other').toLowerCase() === currentSection.toLowerCase());
      }
      
      // Apply direction filter based on primary timeframe
      if (direction === 'bull') {
        data = data.filter(item => {
          const tfs = item.mssbos.timeframes;
          const dir = tfs[primaryTf]?.direction || (typeof tfs[primaryTf] === 'string' ? tfs[primaryTf] : null);
          return dir === 'BULL';
        });
      } else if (direction === 'bear') {
        data = data.filter(item => {
          const tfs = item.mssbos.timeframes;
          const dir = tfs[primaryTf]?.direction || (typeof tfs[primaryTf] === 'string' ? tfs[primaryTf] : null);
          return dir === 'BEAR';
        });
      }
      
      // Calculate scores and sort
      data = data.map(item => ({
        ...item,
        _mssbosScore: getMssBosScore(item, primaryTf)
      }));
      
      if (sortOrder === 'bullish') {
        data.sort((a, b) => b._mssbosScore.score - a._mssbosScore.score);
      } else if (sortOrder === 'bearish') {
        data.sort((a, b) => a._mssbosScore.score - b._mssbosScore.score);
      } else {
        data.sort((a, b) => a.symbol.localeCompare(b.symbol));
      }
      
      if (data.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      
      // Render grid rows
      tbody.innerHTML = data.map(item => {
        const tfs = item.mssbos.timeframes || {};
        const score = item._mssbosScore;
        
        const renderTfCell = (tf) => {
          const tfData = tfs[tf];
          const dir = tfData?.direction || (typeof tfData === 'string' ? tfData : null);
          const signalType = tfData?.signalType || '';
          
          if (dir === 'BULL') {
            return `<td class="px-2 py-2 text-center"><span class="inline-block w-8 py-1 rounded text-xs font-bold bg-green-600/30 text-green-400" title="${signalType || 'BULL'}">${signalType || '‚Üë'}</span></td>`;
          } else if (dir === 'BEAR') {
            return `<td class="px-2 py-2 text-center"><span class="inline-block w-8 py-1 rounded text-xs font-bold bg-red-600/30 text-red-400" title="${signalType || 'BEAR'}">${signalType || '‚Üì'}</span></td>`;
          }
          return `<td class="px-2 py-2 text-center"><span class="text-gray-600">-</span></td>`;
        };
        
        const scoreColor = score.score > 0 ? 'text-green-400' : score.score < 0 ? 'text-red-400' : 'text-gray-400';
        const scoreDisplay = `${score.bullCount}‚Üë ${score.bearCount}‚Üì`;
        
        return `
          <tr class="table-row cursor-pointer hover:bg-gray-800/50" onclick="showDetail('${item.symbol}')">
            <td class="px-3 py-2 sticky left-0 bg-gray-900 z-10"><span class="font-semibold">${item.symbol}</span></td>
            ${TIMEFRAMES.map(tf => renderTfCell(tf)).join('')}
            <td class="px-3 py-2 text-center"><span class="${scoreColor} text-xs">${scoreDisplay}</span></td>
            <td class="px-3 py-2">${renderLinks(item.symbol)}</td>
          </tr>
        `;
      }).join('');
      
      // Highlight primary TF column header
      document.querySelectorAll('#mssbosTable thead th').forEach((th, idx) => {
        th.classList.remove('bg-cyan-900/50', 'text-cyan-400');
        const tfIndex = TIMEFRAMES.indexOf(primaryTf);
        if (idx === tfIndex + 1) { // +1 because first column is Symbol
          th.classList.add('bg-cyan-900/50', 'text-cyan-400');
        }
      });
    }

    // Utilities
    function formatPrice(p) { if (!p) return '-'; if (p < 0.0001) return p.toExponential(3); if (p < 1) return p.toFixed(6); if (p < 100) return p.toFixed(4); return p.toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    function formatChange(c) { if (c === undefined || c === null) return '<span class="text-gray-500">-</span>'; const color = c >= 0 ? 'text-green-400' : 'text-red-400'; return `<span class="${color}">${c >= 0 ? '+' : ''}${c.toFixed(2)}%</span>`; }
    function formatTime(ts) { if (!ts) return '-'; const diff = (Date.now() - ts) / 1000; if (diff < 60) return 'Now'; if (diff < 3600) return `${Math.floor(diff/60)}m`; if (diff < 86400) return `${Math.floor(diff/3600)}h`; return new Date(ts).toLocaleDateString(); }
    function refreshData() { fetchDashboard(); }

    // Init
    document.addEventListener('DOMContentLoaded', () => { fetchDashboard(); toggleAutoRefresh(); });
  </script>
</body>
</html>
